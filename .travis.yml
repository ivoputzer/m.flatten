  language: node_js
  git:
    depth: 1
  node_js:
  - 10
  - 9
  # - 8
  # - 7
  # - 6
  # - 5
  # - 4
  jobs:
    allow_failures:
    - node_js: 5
    - node_js: 4
    include:
    - stage: lint
      install: npm install standard
      script: standard
      # on: branch: *
    - stage: cover
      install: npm install nyc coveralls
      script:
      - nyc --reporter=lcov npm test
      deploy:
      - provider: script
        skip_cleanup: true
        script:
        - nyc report --reporter=text-lcov | coveralls --verbose
      - provider: pages
        skip_cleanup: true
        local-dir: coverage/lcov-report
        github-token: $GITHUB_TOKEN
        on:
          repo: $TRAVIS_REPO_SLUG
          branch: master
    - stage: push
      install: skip
      script: skip
      before_deploy:
      - >
        export BEFORE_DEPLOY_NPM_PACKAGE_VERSION=$(npm view $PWD version)
      after_deploy:
      - >
        export AFTER_DEPLOY_NPM_PACKAGE_VERSION=$(npm view $PWD version)
        if [ "$PREVIOUS_MODULE_VERSION" -ne "$AFTER_DEPLOY_NPM_PACKAGE_VERSION" ]; then
          export NPM_DEPLOYMENT_SUCCESS=1;
          if [ "$MODULE_VERSION" -eq $(npm view $PWD version) ]; then
            echo "in previous deployment npm version has been bumped and successfully published"
          fi
        fi
      deploy:
      - provider: npm
        email: ivo.putzer@gmail.com
        skip_cleanup: true
        api_key: $NPM_TOKEN
        on:
          repo: $TRAVIS_REPO_SLUG
          branch: master

      - provider: releases
        skip_cleanup: true
        api_key: $GITHUB_API_KEY
        file_glob: true
        file: m.flatten-*.tgz
        on:
          repo: $TRAVIS_REPO_SLUG
          branch: master
          condition: "$PREVIOUS_MODULE_VERSION" != "$AFTER_DEPLOY_NPM_PACKAGE_VERSION"
        # - provider: npm
        #   email: ivo.putzer@gmail.com
        #   api_key: $NPM_TOKEN
        #   on:
        #     repo: $TRAVIS_REPO_SLUG
        #     branch: master
      # before_deploy:
      # after_deploy:
      # - npm view $PWD version
      # - git config --local user.name "Travis CI"
      # - git config --local user.email "travis@travis-ci.org"
      # - git tag $(npm run --silent node -- --print "process.env.npm_package_version")
      # - git tag -l
    #   after_deploy:
    #   - npm_package_version=$(npm run --silent node -- --print "process.env.npm_package_version")
    #   - git rev-parse -q --verify "refs/tags/$npm_package_version" >/dev/null
    #   # - npm run --silent node -- --print "process.env.npm_package_version"
    #   # -
  notifications:
    email: false
